<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Квадрат Декарта</title>
    <link rel="stylesheet" href="codemirror.css">
    <link rel="stylesheet" href="midnight.css">
    <link rel="stylesheet" href="solarized.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="big-square">
        <div class="square square_tl">
            <h3 class="square__header">Что <em class="em em_positive">будет</em>, если это <em class="em em_positive">произойдет</em>?</h3>
            <textarea class="square__text" name="happens" cols="30" rows="10"></textarea>
        </div>
        <div class="square square_tr">
            <h3 class="square__header">Что <em class="em em_positive">будет</em>, если это <em class="em em_negative">не произойдет</em>?</h3>
            <textarea class="square__text" name="doesnt_happen" cols="30" rows="10"></textarea>
        </div>
        <div class="square square_bl">
            <h3 class="square__header">Чего <em class="em em_negative">не будет</em>, если <em class="em em_positive">это произойдет</em>?</h3>
            <textarea class="square__text" name="wont_happen_happens" cols="30" rows="10"></textarea>
        </div>
        <div class="square square_br">
            <h3 class="square__header">Чего <em class="em em_negative">не будет</em>, если это <em class="em em_negative">не произойдет</em>?</h3>
            <textarea class="square__text" name="wont_happen_doesnt_happens" cols="30" rows="10"></textarea>
        </div>
    </div>
    <footer class="footer">
        <a class="about-link" href="https://www.adme.ru/svoboda-psihologiya/prostoj-sposob-prinyat-reshenie-860460/">О технике</a>
        <span class="howto">Можно использовать <a href="https://guides.hexlet.io/markdown/">маркдаун</a>.</span>
        <label class="vim-mode">
            <input id="vimMode" type="checkbox">
            Vim-режим
        </label>
    </footer>
    <script src="codemirror.js"></script>
    <script src="markdown.js"></script>
    <script src="continuelist.js"></script>
    <script src="vim.js"></script>
    <script>
    const isVimModeEnabled = localStorage.getItem('vimMode') === '1';
    const vimModeCheckbox = document.getElementById('vimMode');
    vimModeCheckbox.checked = isVimModeEnabled;

    const defaultText = `- успех;\n- восторг;\n- я стану более лучше одеваться.`;

    const options = {
        mode: 'markdown',
        lineNumbers: true,
        theme: "default",
        lineNumbers: false,
        extraKeys: {
            "Enter": "newlineAndIndentContinueMarkdownList",
            "Ctrl-S": save,
            "Cmd-S": save
        }
    };

    function save(cm) {
        cm.save();
        const el = cm.display.wrapper;
        el.classList.add('saving');
        setTimeout(() => {
            el.classList.remove('saving')
        }, 500);
    }

    if (isVimModeEnabled) {
        options.keyMap = 'vim';
    }

    document.querySelectorAll('.square__text').forEach((el, index) => {
        options.autofocus = index === 0;
        const editor = CodeMirror.fromTextArea(el, options);

        const savedText = localStorage.getItem(el.name) || '';
        editor.getDoc().setValue(savedText);

        if(index === 0 && savedText == '') {
            editor.getDoc().setValue(defaultText);
        }

        editor.on('change', function(cm, co) {
            const text = cm.getValue();
            const el = cm.getTextArea();
            localStorage.setItem(el.name, text);
        })
    });

    vimModeCheckbox.addEventListener('change', toggleVimMode);

    function toggleVimMode() {
        localStorage.setItem('vimMode', +this.checked);
        location.reload();
    }
    </script>
</body>

</html>